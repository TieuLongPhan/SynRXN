name: Build & Verify Manifest

on:
  push:
    branches: ['main', 'data']
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    env:
      MANIFEST_ROOT: Data
      MANIFEST_OUT: manifest.json
      PYPROJECT: pyproject.toml
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml PyYAML

      - name: Debug: show repo snapshot
        run: |
          echo "PWD: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          git rev-parse --abbrev-ref HEAD || true
          echo "Repository listing (top 200 files):"
          find . -maxdepth 5 -type f -not -path "./.git/*" | sed -n '1,200p' || true
          echo "Looking for manifest/verify scripts:"
          find . -iname "build_manifest.py" -o -iname "verify_manifest.py" -o -iname "build_citation_from_manifest.py" -print || true

      - name: Build manifest (flexible)
        id: build_manifest
        run: |
          set -euo pipefail
          ROOT="${{ env.MANIFEST_ROOT }}"
          OUT="${{ env.MANIFEST_OUT }}"
          PYPROJECT="${{ env.PYPROJECT }}"

          try_run() {
            SCRIPT_PATH="$1"
            shift
            if [ -f "$SCRIPT_PATH" ]; then
              echo "Running $SCRIPT_PATH $*"
              python "$SCRIPT_PATH" "$@"
              return 0
            fi
            return 1
          }

          if try_run "./build_manifest.py" --root "$ROOT" --output "$OUT" --pyproject "$PYPROJECT" --verbose; then
            exit 0
          fi
          if try_run "./synrxn/build_manifest.py" --root "$ROOT" --output "$OUT" --pyproject "$PYPROJECT" --verbose; then
            exit 0
          fi
          if try_run "./scripts/build_manifest.py" --root "$ROOT" --output "$OUT" --pyproject "$PYPROJECT" --verbose; then
            exit 0
          fi

          if [ -f "./pyproject.toml" ] || [ -f "./setup.py" ] || [ -f "./setup.cfg" ]; then
            echo "Installing package (editable) and trying module entrypoints..."
            pip install -e .
            if python -c "import importlib, sys; importlib.import_module('synrxn.build_manifest')" 2>/dev/null; then
              python -m synrxn.build_manifest --root "$ROOT" --output "$OUT" --pyproject "$PYPROJECT" --verbose
              exit 0
            fi
          fi

          echo "ERROR: build_manifest() entrypoint not found. Searched common locations."
          exit 1

      - name: Verify manifest (flexible)
        id: verify_manifest
        run: |
          set -euo pipefail
          MANIFEST="${{ env.MANIFEST_OUT }}"
          ROOT="${{ env.MANIFEST_ROOT }}"

          try_run() {
            SCRIPT="$1"; shift
            if [ -f "$SCRIPT" ]; then
              echo "Running $SCRIPT $*"
              python "$SCRIPT" "$@"
              return 0
            fi
            return 1
          }

          if try_run "./verify_manifest.py" --manifest "$MANIFEST" --root "$ROOT"; then
            exit 0
          fi
          if try_run "./synrxn/verify_manifest.py" --manifest "$MANIFEST" --root "$ROOT"; then
            exit 0
          fi
          if try_run "./scripts/verify_manifest.py" --manifest "$MANIFEST" --root "$ROOT"; then
            exit 0
          fi

          if python -c "import importlib, sys; importlib.import_module('synrxn.verify_manifest')" 2>/dev/null; then
            python -m synrxn.verify_manifest --manifest "$MANIFEST" --root "$ROOT"
            exit 0
          fi

          echo "WARNING: verify_manifest entrypoint not found; continuing."
          exit 0

      - name: Build CITATION.cff from manifest (flexible)
        id: build_cff
        run: |
          set -euo pipefail
          MANIFEST="${{ env.MANIFEST_OUT }}"
          OUT="CITATION.cff"

          try_run() {
            SCRIPT="$1"; shift
            if [ -f "$SCRIPT" ]; then
              python "$SCRIPT" "$@"
              return 0
            fi
            return 1
          }

          if try_run "./build_citation_from_manifest.py" --manifest "$MANIFEST" --output "$OUT" --verbose; then
            exit 0
          fi
          if try_run "./synrxn/build_citation_from_manifest.py" --manifest "$MANIFEST" --output "$OUT" --verbose; then
            exit 0
          fi
          if try_run "./scripts/build_citation_from_manifest.py" --manifest "$MANIFEST" --output "$OUT" --verbose; then
            exit 0
          fi

          if python -c "import importlib, sys; importlib.import_module('synrxn.build_citation_from_manifest')" 2>/dev/null; then
            python -m synrxn.build_citation_from_manifest --manifest "$MANIFEST" --output "$OUT" --verbose
            exit 0
          fi

          echo "No citation builder detected; continuing."
          exit 0

      - name: Locate & copy generated manifest/citation to repo root (so upload/commit works)
        run: |
          set -euo pipefail
          # Find manifest.json anywhere in workspace (exclude .git)
          MANIFEST_LOCATION=$(find . -type f -name "manifest.json" -not -path "./.git/*" -print -quit || true)
          CITATION_LOCATION=$(find . -type f -name "CITATION.cff" -not -path "./.git/*" -print -quit || true)

          echo "manifest found at: ${MANIFEST_LOCATION:-<none>}"
          echo "citation found at: ${CITATION_LOCATION:-<none>}"

          if [ -n "$MANIFEST_LOCATION" ]; then
            cp -v "$MANIFEST_LOCATION" ./manifest.json
          else
            echo "Warning: manifest.json not generated."
          fi

          if [ -n "$CITATION_LOCATION" ]; then
            cp -v "$CITATION_LOCATION" ./CITATION.cff
          else
            echo "Note: CITATION.cff not present (that's OK if you don't generate it)."
          fi

          echo "Root files now:"
          ls -l manifest.json CITATION.cff || true

      - name: Show manifest quick info (size, sha256, head)
        if: always()
        run: |
          set -euo pipefail
          if [ -f ./manifest.json ]; then
            echo "manifest.json size and sha256:"
            stat -c "%n %s bytes" manifest.json || true
            sha256sum manifest.json || true
            echo "First 120 lines of manifest.json for quick inspection:"
            sed -n '1,120p' manifest.json || true
          else
            echo "manifest.json not present in repo root."
            exit 1
          fi

      - name: Commit updated manifest and CITATION.cff (if any)
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add manifest.json CITATION.cff || true
          if ! git diff --staged --quiet; then
            git commit -m "chore(manifest): update manifest.json and CITATION.cff [ci skip]" || true
            git push origin HEAD || (echo "git push failed" && exit 1)
          else
            echo "No changes to commit"
          fi

      - name: Upload artifacts (manifest + citation)
        uses: actions/upload-artifact@v4
        with:
          name: dataset-manifest
          path: |
            manifest.json
            CITATION.cff

      - name: Final debug listing (always)
        if: always()
        run: |
          echo "Final workspace listing (top 200 files):"
          find . -type f -not -path "./.git/*" | sed -n '1,200p'
