name: "Build & Verify Manifest"

on:
  push:
    branches: ['main', 'data']
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    env:
      MANIFEST_ROOT: Data
      MANIFEST_OUT: manifest.json
      PYPROJECT_PATH: ./pyproject.toml

    steps:
      - name: "Checkout (full history)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: "Set up Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "Install Python runtime deps"
        run: |
          python -m pip install --upgrade pip
          pip install toml PyYAML

      - name: "Debug initial repo snapshot"
        run: |
          echo "pwd: $(pwd)"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-<not-set>}"
          echo "MANIFEST_ROOT=${MANIFEST_ROOT}"
          echo "MANIFEST_OUT=${MANIFEST_OUT}"
          echo "PYPROJECT_PATH=${PYPROJECT_PATH}"
          echo "Workspace listing:"
          ls -la "${GITHUB_WORKSPACE:-.}" || true
          echo "Parent of workspace listing:"
          ls -la "${GITHUB_WORKSPACE:-.}/.." || true

      - name: "Build manifest (try short flags + fallbacks)"
        id: build_manifest
        run: |
          set -euo pipefail
          set -x

          # The repo root (parent of GITHUB_WORKSPACE) is where we want manifest to end up
          REPO_ROOT=$(cd "${GITHUB_WORKSPACE}/.." 2>/dev/null && pwd || echo "${GITHUB_WORKSPACE:-.}")
          echo "REPO_ROOT: $REPO_ROOT"

          OUT="$REPO_ROOT/${MANIFEST_OUT}"
          CITATION_OUT="$REPO_ROOT/CITATION.cff"
          ROOT="${MANIFEST_ROOT}"
          PYPROJECT="${PYPROJECT_PATH}"

          echo "Target manifest path: $OUT"
          mkdir -p "$(dirname "$OUT")"

          # 1) Preferred: script with short flags (-d data dir, -m manifest, -c citation)
          if [ -f "./synrxn/build_manifest.py" ]; then
            echo "Trying script with short flags (-d -m -c)"
            if python ./synrxn/build_manifest.py -d "$ROOT" -m "$OUT" -c "$CITATION_OUT" -v 2>&1 | sed -n '1,400p'; then
              echo "Script created manifest using -m."
              echo "ok=true" >> $GITHUB_OUTPUT
              echo "out=$OUT" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Script with short flags failed or didn't create manifest; trying fallbacks."
            fi
          else
            echo "./synrxn/build_manifest.py not present; will try fallbacks."
          fi

          # 2) Run script with working directory = REPO_ROOT (if script writes to cwd)
          if [ -f "./synrxn/build_manifest.py" ]; then
            echo "Running script from REPO_ROOT so files written to cwd land in repo root"
            if (cd "$REPO_ROOT" && python synrxn/build_manifest.py -v) 2>&1 | sed -n '1,400p'; then
              echo "Script executed in repo root; check $OUT"
              echo "ok=true" >> $GITHUB_OUTPUT
              echo "out=$OUT" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Script in REPO_ROOT returned non-zero or didn't create manifest; continuing."
            fi
          fi

          # 3) Install editable and try module with short flags
          if [ -f "./pyproject.toml" ] || [ -f "./setup.py" ] || [ -f "./setup.cfg" ]; then
            echo "Attempting to install package in editable mode..."
            python -m pip install -e . 2>&1 | sed -n '1,200p' || true
          fi

          echo "Trying module invocation with -m and -c"
          if python -m synrxn.build_manifest -m "$OUT" -c "$CITATION_OUT" -v 2>&1 | sed -n '1,400p'; then
            echo "Module invocation succeeded and should have created $OUT"
            echo "ok=true" >> $GITHUB_OUTPUT
            echo "out=$OUT" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 4) Last resort: run module/script without args in repo root
          echo "Last-resort: running module without args in REPO_ROOT"
          if (cd "$REPO_ROOT" && python -m synrxn.build_manifest -v) 2>&1 | sed -n '1,400p'; then
            echo "Module ran in repo root; manifest may be created at default location"
            echo "ok=false" >> $GITHUB_OUTPUT
            echo "out=$OUT" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "All attempts to build manifest failed."
          echo "ok=false" >> $GITHUB_OUTPUT
          echo "out=$OUT" >> $GITHUB_OUTPUT
          exit 0

      - name: "Locate and copy manifest/citation into workspace root"
        id: locate
        run: |
          set -euo pipefail
          set -x

          REPO_ROOT=$(cd "${GITHUB_WORKSPACE}/.." 2>/dev/null && pwd || echo "${GITHUB_WORKSPACE:-.}")
          echo "REPO_ROOT: $REPO_ROOT"

          # candidate locations
          FOUND_MANIFEST=""
          FOUND_CITATION=""

          for root in "${GITHUB_WORKSPACE:-.}" "$REPO_ROOT"; do
            root=$(cd "$root" 2>/dev/null && pwd || echo "$root")
            echo "Searching in: $root"
            if [ -z "$FOUND_MANIFEST" ]; then
              cand=$(find "$root" -maxdepth 6 -type f -iname "manifest.json" -not -path "*/.git/*" -print -quit 2>/dev/null || true)
              if [ -n "$cand" ]; then
                FOUND_MANIFEST="$cand"
                echo "Found manifest candidate: $FOUND_MANIFEST"
              fi
            fi
            if [ -z "$FOUND_CITATION" ]; then
              candc=$(find "$root" -maxdepth 6 -type f -iname "CITATION.cff" -not -path "*/.git/*" -print -quit 2>/dev/null || true)
              if [ -n "$candc" ]; then
                FOUND_CITATION="$candc"
                echo "Found citation candidate: $FOUND_CITATION"
              fi
            fi
            if [ -n "$FOUND_MANIFEST" ] && [ -n "$FOUND_CITATION" ]; then
              break
            fi
          done

          # copy found files into workspace root for reliable uploading and commits
          DEST_MANIFEST="${GITHUB_WORKSPACE}/${MANIFEST_OUT}"
          DEST_CITATION="${GITHUB_WORKSPACE}/CITATION.cff"

          if [ -n "$FOUND_MANIFEST" ]; then
            if [ "$FOUND_MANIFEST" != "$DEST_MANIFEST" ]; then
              echo "Copying manifest: $FOUND_MANIFEST -> $DEST_MANIFEST"
              mkdir -p "$(dirname "$DEST_MANIFEST")"
              cp -v "$FOUND_MANIFEST" "$DEST_MANIFEST" || true
            else
              echo "Manifest already in workspace; no copy needed."
            fi
          else
            echo "No manifest found."
          fi

          if [ -n "$FOUND_CITATION" ]; then
            if [ "$FOUND_CITATION" != "$DEST_CITATION" ]; then
              echo "Copying citation: $FOUND_CITATION -> $DEST_CITATION"
              mkdir -p "$(dirname "$DEST_CITATION")"
              cp -v "$FOUND_CITATION" "$DEST_CITATION" || true
            else
              echo "Citation already in workspace; no copy needed."
            fi
          else
            echo "No CITATION.cff found."
          fi

          # emit a simple output (useful for debugging later)
          echo "found_manifest=${FOUND_MANIFEST:-}" >> $GITHUB_OUTPUT || true
          echo "found_citation=${FOUND_CITATION:-}" >> $GITHUB_OUTPUT || true

          echo "Workspace top listing:"
          ls -la "${GITHUB_WORKSPACE}" | sed -n '1,200p' || true

      - name: "Debug: show files-to-upload and existence"
        run: |
          echo "Listing workspace root:"
          ls -la "${GITHUB_WORKSPACE:-.}" | sed -n '1,200p' || true
          echo "Check manifest.json in workspace:"
          if [ -f "${GITHUB_WORKSPACE:-.}/manifest.json" ]; then
            echo "manifest.json present ($(stat -c '%s' "${GITHUB_WORKSPACE:-.}/manifest.json")) bytes"
          else
            echo "manifest.json NOT found at ${GITHUB_WORKSPACE:-.}/manifest.json"
          fi
          echo "Check CITATION.cff in workspace:"
          if [ -f "${GITHUB_WORKSPACE:-.}/CITATION.cff" ]; then
            echo "CITATION.cff present ($(stat -c '%s' "${GITHUB_WORKSPACE:-.}/CITATION.cff")) bytes"
          else
            echo "CITATION.cff NOT found at ${GITHUB_WORKSPACE:-.}/CITATION.cff"
          fi

      - name: "Upload artifacts (manifest + citation from workspace)"
        uses: actions/upload-artifact@v4
        with:
          name: dataset-manifest
          path: |
            manifest.json
            CITATION.cff

      - name: "Commit & push manifest and CITATION.cff (check workspace files)"
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          set -euo pipefail
          set -x

          echo "github.event_name='${EVENT_NAME:-}'"

          # do not attempt to push on pull_request events (forks won't have push rights)
          if [ "${EVENT_NAME:-}" = "pull_request" ]; then
            echo "Event is pull_request â€” skipping push to avoid permission issues."
            exit 0
          fi

          REPO_ROOT=$(cd "${GITHUB_WORKSPACE}/.." 2>/dev/null && pwd || echo "")
          if [ -z "$REPO_ROOT" ]; then
            echo "Could not determine REPO_ROOT; aborting push."
            exit 0
          fi
          echo "REPO_ROOT: $REPO_ROOT"

          WORK_MANIFEST="${GITHUB_WORKSPACE}/manifest.json"
          WORK_CITATION="${GITHUB_WORKSPACE}/CITATION.cff"
          found_any=false
          if [ -f "$WORK_MANIFEST" ]; then
            echo "Found workspace manifest: $WORK_MANIFEST"
            found_any=true
          fi
          if [ -f "$WORK_CITATION" ]; then
            echo "Found workspace citation: $WORK_CITATION"
            found_any=true
          fi

          if [ "$found_any" != "true" ]; then
            echo "No manifest/CITATION in workspace to commit. Exiting."
            exit 0
          fi

          # copy workspace files to repo root so we modify the tracked checkout
          if [ -f "$WORK_MANIFEST" ]; then
            if [ ! -f "$REPO_ROOT/manifest.json" ] || ! cmp -s "$WORK_MANIFEST" "$REPO_ROOT/manifest.json"; then
              echo "Copying workspace manifest to repo root"
              cp -v "$WORK_MANIFEST" "$REPO_ROOT/manifest.json"
            else
              echo "Repo-root manifest identical; no copy."
            fi
          fi
          if [ -f "$WORK_CITATION" ]; then
            if [ ! -f "$REPO_ROOT/CITATION.cff" ] || ! cmp -s "$WORK_CITATION" "$REPO_ROOT/CITATION.cff"; then
              echo "Copying workspace CITATION.cff to repo root"
              cp -v "$WORK_CITATION" "$REPO_ROOT/CITATION.cff"
            else
              echo "Repo-root CITATION.cff identical; no copy."
            fi
          fi

          # require a git checkout in REPO_ROOT to commit
          if [ ! -d "$REPO_ROOT/.git" ]; then
            echo "Repo root is not a git checkout; skipping commit/push."
            exit 0
          fi

          cd "$REPO_ROOT"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add manifest.json CITATION.cff || true

          if git diff --cached --quiet; then
            echo "No changes staged for commit."
            exit 0
          fi

          git commit -m "chore(manifest): update manifest.json and CITATION.cff [ci skip]" || true

          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ -z "$BRANCH" ]; then
            BRANCH="${GITHUB_HEAD_REF:-main}"
          fi
          echo "Pushing to branch: $BRANCH"

          # push using origin configured by actions/checkout (GITHUB_TOKEN)
          git push origin "HEAD:${BRANCH}" || (echo "git push failed" && exit 1)

      - name: "Final debug listing"
        if: ${{ always() }}
        run: |
          echo "Final workspace listing (top 400 files):"
          find . -type f -not -path "./.git/*" | sed -n '1,400p'
