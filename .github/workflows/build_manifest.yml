name: Build & Verify Manifest

on:
  push:
    branches: ['main', 'data']
    tags:
      - 'v*'
  workflow_dispatch:

# Allow workflow to write to the repo (commit / push)
permissions:
  contents: write
  id-token: write

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml PyYAML

      - name: Show repo & python info
        run: |
          echo "PWD: $(pwd)"
          git status --porcelain -v
          python --version
          pip --version

      - name: Build manifest (creates manifest.json)
        id: build_manifest
        run: |
          # adjust path to build_manifest.py if you kept it under synrxn/
          python build_manifest.py --root Data --output manifest.json --pyproject pyproject.toml --verbose

      - name: Verify manifest (checks sizes & SHA256)
        id: verify_manifest
        run: |
          # ensure verify script path is correct; default here assumes repo root
          python verify_manifest.py --manifest manifest.json --root Data
        # If verification fails, we want CI to fail (so we don't push broken manifests)
        continue-on-error: false

      - name: Build CITATION.cff from manifest
        id: build_cff
        run: |
          python build_citation_from_manifest.py --manifest manifest.json --output CITATION.cff --verbose

      - name: Commit updated manifest and CITATION.cff (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add manifest.json CITATION.cff || true
          # commit only if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore(manifest): update manifest.json and CITATION.cff [ci skip]" || true
            # push back to the same branch / ref
            git push origin HEAD
          else
            echo "No changes to manifest.json or CITATION.cff"
          fi

      - name: Upload artifacts (manifest + citation)
        uses: actions/upload-artifact@v4
        with:
          name: dataset-manifest
          path: |
            manifest.json
            CITATION.cff
