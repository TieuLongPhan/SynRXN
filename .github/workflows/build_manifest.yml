name: "Build & Verify Manifest"

on:
  push:
    branches: ['main', 'data']
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    env:
      MANIFEST_ROOT: Data
      MANIFEST_OUT: manifest.json
      PYPROJECT_PATH: ./pyproject.toml

    steps:
      - name: "Checkout (full history)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: "Set up Python 3.11"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "Install Python runtime deps"
        run: |
          python -m pip install --upgrade pip
          pip install toml PyYAML

      - name: "Debug initial repo snapshot"
        run: |
          echo "PWD: $(pwd)"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE:-<not-set>}"
          echo "MANIFEST_ROOT=${MANIFEST_ROOT}"
          echo "MANIFEST_OUT=${MANIFEST_OUT}"
          echo "PYPROJECT_PATH=${PYPROJECT_PATH}"
          git rev-parse --abbrev-ref HEAD || true
          echo "Top-level files (pwd):"
          ls -la || true
          echo "Top-level files (workspace):"
          ls -la "${GITHUB_WORKSPACE:-.}" || true

      - name: "Build manifest using ./synrxn/build_manifest.py (preferred)"
        id: build_manifest_script
        run: |
          set -euo pipefail
          set -x
          ROOT="${MANIFEST_ROOT}"
          OUT="${GITHUB_WORKSPACE}/${MANIFEST_OUT}"
          PYPROJECT="${PYPROJECT_PATH}"

          echo "Attempting to run the script at ./synrxn/build_manifest.py"
          mkdir -p "$(dirname "$OUT")"

          if [ -f "./synrxn/build_manifest.py" ]; then
            echo "Invoking: python ./synrxn/build_manifest.py --root \"$ROOT\" --output \"$OUT\" --pyproject \"$PYPROJECT\" --verbose"
            if python ./synrxn/build_manifest.py --root "$ROOT" --output "$OUT" --pyproject "$PYPROJECT" --verbose 2>&1 | sed -n '1,400p'; then
              echo "Script succeeded. Listing output:"
              ls -l "$OUT" || true
              echo "ok=true" >> $GITHUB_OUTPUT
              echo "out=$OUT" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "Script returned non-zero exit code."
            fi
          else
            echo "./synrxn/build_manifest.py not found."
          fi

          echo "Script invocation did not produce manifest at $OUT (or failed). Marking ok=false"
          echo "ok=false" >> $GITHUB_OUTPUT
          echo "out=$OUT" >> $GITHUB_OUTPUT
          exit 0

      - name: "Fallback: try module synrxn.build_manifest (if script failed)"
        if: ${{ steps.build_manifest_script.outputs.ok == 'false' }}
        id: build_manifest_module
        run: |
          set -euo pipefail
          set -x
          OUT="${GITHUB_WORKSPACE}/${MANIFEST_OUT}"
          PYPROJECT="${PYPROJECT_PATH}"
          ROOT="${MANIFEST_ROOT}"

          echo "Installing package in editable mode (if packaging files present)..."
          if [ -f "./pyproject.toml" ] || [ -f "./setup.py" ] || [ -f "./setup.cfg" ]; then
            python -m pip install -e . 2>&1 | sed -n '1,200p' || true
          fi

          echo "Trying: python -m synrxn.build_manifest --output \"$OUT\" --verbose"
          if python -m synrxn.build_manifest --output "$OUT" --verbose 2>&1 | sed -n '1,400p'; then
            echo "Module invocation succeeded and (hopefully) created $OUT"
            ls -l "$OUT" || true
            echo "ok=true" >> $GITHUB_OUTPUT
            echo "out=$OUT" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Module invocation failed (or didn't create manifest)."
          echo "ok=false" >> $GITHUB_OUTPUT
          echo "out=$OUT" >> $GITHUB_OUTPUT
          exit 0

      - name: "Locate and copy manifest/citation to workspace root (robust, handles parent dir)"
        run: |
          set -euo pipefail
          # canonical workspace destination
          ABS_MANIFEST="${GITHUB_WORKSPACE}/${MANIFEST_OUT}"
          ABS_CITATION="${GITHUB_WORKSPACE}/CITATION.cff"

          echo "Canonical manifest destination: $ABS_MANIFEST"
          echo "Canonical citation destination: $ABS_CITATION"

          # determine repo top-level (this will return parent workspace dir when running inside nested folder)
          REPO_TOP="$(git rev-parse --show-toplevel 2>/dev/null || true)"
          echo "git rev-parse --show-toplevel => '${REPO_TOP:-<none>}'"

          # Build search roots: include GITHUB_WORKSPACE and REPO_TOP (if different)
          SEARCH_ROOTS=()
          SEARCH_ROOTS+=("${GITHUB_WORKSPACE:-.}")
          if [ -n "${REPO_TOP:-}" ] && [ "${REPO_TOP}" != "${GITHUB_WORKSPACE:-.}" ]; then
            SEARCH_ROOTS+=("${REPO_TOP}")
          fi
          # also include repository parent just in case
          SEARCH_ROOTS+=("${GITHUB_WORKSPACE:-.}/..")

          echo "Search roots: ${SEARCH_ROOTS[*]}"

          FOUND_MANIFEST=""
          FOUND_CITATION=""

          for root in "${SEARCH_ROOTS[@]}"; do
            # normalize root path
            root=$(cd "$root" 2>/dev/null && pwd || echo "$root")
            echo "Searching in: $root"
            # find candidate manifest
            if [ -z "$FOUND_MANIFEST" ]; then
              cand=$(find "$root" -maxdepth 6 -type f -iname "manifest.json" -not -path "*/.git/*" -print -quit 2>/dev/null || true)
              if [ -n "$cand" ]; then
                FOUND_MANIFEST="$cand"
                echo "Found manifest candidate: $FOUND_MANIFEST"
              fi
            fi
            if [ -z "$FOUND_CITATION" ]; then
              candc=$(find "$root" -maxdepth 6 -type f -iname "CITATION.cff" -not -path "*/.git/*" -print -quit 2>/dev/null || true)
              if [ -n "$candc" ]; then
                FOUND_CITATION="$candc"
                echo "Found citation candidate: $FOUND_CITATION"
              fi
            fi
            # break early if both found
            if [ -n "$FOUND_MANIFEST" ] && [ -n "$FOUND_CITATION" ]; then
              break
            fi
          done

          # copy only when source is different from destination
          if [ -n "$FOUND_MANIFEST" ]; then
            if [ "$FOUND_MANIFEST" != "$ABS_MANIFEST" ]; then
              echo "Copying manifest: $FOUND_MANIFEST -> $ABS_MANIFEST"
              mkdir -p "$(dirname "$ABS_MANIFEST")"
              cp -v "$FOUND_MANIFEST" "$ABS_MANIFEST" || true
            else
              echo "Manifest is already at destination; skipping copy."
            fi
          else
            echo "No manifest.json found in any search root."
          fi

          if [ -n "$FOUND_CITATION" ]; then
            if [ "$FOUND_CITATION" != "$ABS_CITATION" ]; then
              echo "Copying citation: $FOUND_CITATION -> $ABS_CITATION"
              mkdir -p "$(dirname "$ABS_CITATION")"
              cp -v "$FOUND_CITATION" "$ABS_CITATION" || true
            else
              echo "Citation is already at destination; skipping copy."
            fi
          else
            echo "No CITATION.cff found in any search root."
          fi

          echo "Workspace root listing after copy attempt:"
          ls -la "${GITHUB_WORKSPACE}" || true

      - name: "Check manifest and citation files (robust search)"
        id: check_files
        run: |
          set -uo pipefail
          patterns=("manifest.json" "manifest-*.json" "*manifest*.json" "CITATION.cff" "citation.cff")
          found_paths=()

          echo "Searching workspace ${GITHUB_WORKSPACE:-$(pwd)} for manifest/citation files..."
          for p in "${patterns[@]}"; do
            while IFS= read -r f; do
              case "$f" in
                ./.git/*) continue ;;
              esac
              found_paths+=("$f")
            done < <(find "${GITHUB_WORKSPACE:-.}" -maxdepth 6 -type f -name "$p" -not -path "*/.git/*" -print 2>/dev/null)
          done

          if [ ${#found_paths[@]} -eq 0 ]; then
            echo "No manifest or citation files found (checked patterns: ${patterns[*]})."
            echo "found=false" >> $GITHUB_OUTPUT
            echo "files=" >> $GITHUB_OUTPUT
            echo "Full listing (first 200 entries):"
            find "${GITHUB_WORKSPACE:-.}" -maxdepth 6 -type f -not -path "*/.git/*" -print -exec stat -c "%n %s bytes" {} \; | sed -n '1,200p'
            exit 0
          fi

          files_space=""
          for f in "${found_paths[@]}"; do
            files_space="$files_space $f"
            echo "FOUND: $f ($(stat -c '%s' "$f") bytes)"
            echo "Head of $f:"
            sed -n '1,80p' "$f" || true
          done
          files_space="${files_space# }"

          echo "found=true" >> $GITHUB_OUTPUT
          echo "files=$files_space" >> $GITHUB_OUTPUT

      - name: "Debug: show files-to-upload and existence"
        run: |
          echo "check_files outputs:"
          echo "  found:  '${{ steps.check_files.outputs.found }}'"
          echo "  files:  '${{ steps.check_files.outputs.files }}'"
          echo
          echo "Listing explicit expected files in workspace:"
          ls -la "${GITHUB_WORKSPACE:-.}" | sed -n '1,200p' || true
          echo
          echo "Check manifest.json:"
          if [ -f "${GITHUB_WORKSPACE:-.}/manifest.json" ]; then
            echo "manifest.json present ($(stat -c '%s' "${GITHUB_WORKSPACE:-.}/manifest.json")) bytes"
          else
            echo "manifest.json NOT found at ${GITHUB_WORKSPACE:-.}/manifest.json"
          fi
          echo "Check CITATION.cff:"
          if [ -f "${GITHUB_WORKSPACE:-.}/CITATION.cff" ]; then
            echo "CITATION.cff present ($(stat -c '%s' "${GITHUB_WORKSPACE:-.}/CITATION.cff")) bytes"
          else
            echo "CITATION.cff NOT found at ${GITHUB_WORKSPACE:-.}/CITATION.cff"
          fi

      - name: "Upload artifacts (explicit paths)"
        if: ${{ steps.check_files.outputs.found == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: dataset-manifest
          path: |
            manifest.json
            CITATION.cff

      - name: "Upload artifacts - no files found (debug)"
        if: ${{ steps.check_files.outputs.found != 'true' }}
        run: |
          echo "No manifest/citation to upload. Printing workspace for debugging:"
          find . -maxdepth 8 -type f -not -path "./.git/*" -print -exec stat -c "%n %s bytes" {} \; | sed -n '1,400p'

      - name: "Commit updated manifest and CITATION.cff (if changed)"
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${MANIFEST_OUT}" "CITATION.cff" || true
          if ! git diff --staged --quiet; then
            git commit -m "chore(manifest): update manifest.json and CITATION.cff [ci skip]" || true
            git push origin "HEAD:${GITHUB_REF#refs/heads/}" || (echo "git push failed" && exit 1)
          else
            echo "No changes to commit."
          fi

      - name: "Final debug listing"
        if: ${{ always() }}
        run: |
          echo "Final workspace listing (top 400 files):"
          find . -type f -not -path "./.git/*" | sed -n '1,400p'
